# ========================================
# Job Manager - Docker Compose
# ========================================
#
# Usage:
#   Build & Start all:     mvn clean package -DskipTests && docker compose up -d --build
#   Start all:             docker compose up -d
#   Stop all:              docker compose down
#   View logs:             docker compose logs -f [service-name]
#
# Endpoints:
#   Eureka Dashboard:      http://localhost:8761
#   API Gateway:           http://localhost:8080
#   Kafka UI:              http://localhost:8090
#
# Note: This setup uses cloud services for databases (Neon) and Redis (Upstash).
#       Only Kafka/Zookeeper run locally in Docker.
# ========================================

services:
    # ========================================
    # Kafka Infrastructure
    # ========================================

    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: jm-zookeeper
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - "2181:2181"
        networks:
            - jm-network
        healthcheck:
            test: ["CMD", "nc", "-z", "localhost", "2181"]
            interval: 10s
            timeout: 5s
            retries: 5

    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: jm-kafka
        depends_on:
            zookeeper:
                condition: service_healthy
        ports:
            - "9092:9092"
            - "29092:29092"
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
            KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
        networks:
            - jm-network
        healthcheck:
            test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
            interval: 10s
            timeout: 10s
            retries: 5

    kafka-ui:
        image: provectuslabs/kafka-ui:latest
        container_name: jm-kafka-ui
        depends_on:
            kafka:
                condition: service_healthy
        ports:
            - "8090:8080"
        environment:
            KAFKA_CLUSTERS_0_NAME: local
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
        networks:
            - jm-network

    # ========================================
    # Service Discovery (Eureka)
    # ========================================

    discovery-server:
        build:
            context: ./job-manager-discovery
            dockerfile: Dockerfile
        image: jm-discovery-server
        container_name: jm-discovery-server
        ports:
            - "8761:8761"
        environment:
            SPRING_PROFILES_ACTIVE: docker
        networks:
            - jm-network
        healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://localhost:8761/actuator/health"]
            interval: 30s
            timeout: 10s
            retries: 5

    # ========================================
    # API Gateway
    # ========================================

    gateway:
        build:
            context: ./job-manager-gateway
            dockerfile: Dockerfile
        image: jm-gateway
        container_name: jm-gateway
        ports:
            - "8080:8080"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
            GATEWAY_AUTH_SERVICE_URL: http://auth-service:8081
        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
            auth-service:
                condition: service_started
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

    # ========================================
    # Application Services
    # ========================================

    auth-service:
        build:
            context: ./job-manager-auth
            dockerfile: Dockerfile
        image: jm-auth-service
        container_name: jm-auth-service
        ports:
            - "8081:8081"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
            OAUTH2_REDIRECT_URI: http://localhost:8080/api/login/oauth2/code/google
        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

    company-service:
        build:
            context: ./job-manager-company
            dockerfile: Dockerfile
        image: jm-company-service
        container_name: jm-company-service
        ports:
            - "8082:8082"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
            FIREBASE_ENABLED: ${FIREBASE_ENABLED:-false}
            FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-devision-job-manager}
            FIREBASE_BUCKET_NAME: ${FIREBASE_BUCKET_NAME:-devision-job-manager.firebasestorage.app}

        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

    jobpost-service:
        build:
            context: ./job-manager-jobpost
            dockerfile: Dockerfile
        image: jm-jobpost-service
        container_name: jm-jobpost-service
        ports:
            - "8083:8083"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

    applicant-search-service:
        build:
            context: ./job-manager-applicant-search
            dockerfile: Dockerfile
        image: jm-applicant-search-service
        container_name: jm-applicant-search-service
        ports:
            - "8084:8084"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
            APPLICANT_SERVICE_AUTH_TOKEN: ${APPLICANT_SERVICE_AUTH_TOKEN}
        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

    subscription-service:
        build:
            context: ./job-manager-subscription
            dockerfile: Dockerfile
        image: jm-subscription-service
        container_name: jm-subscription-service
        ports:
            - "8085:8085"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

    payment-service:
        build:
            context: ./job-manager-payment
            dockerfile: Dockerfile
        image: jm-payment-service
        container_name: jm-payment-service
        ports:
            - "8086:8086"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

    notification-service:
        build:
            context: ./job-manager-notification
            dockerfile: Dockerfile
        image: jm-notification-service
        container_name: jm-notification-service
        ports:
            - "8087:8087"
        env_file:
            - .env
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://discovery-server:8761/eureka/
            SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS}
            TZ: Asia/Ho_Chi_Minh
        depends_on:
            discovery-server:
                condition: service_healthy
            kafka:
                condition: service_healthy
        extra_hosts:
            - "kafka-mulan.duckdns.org:14.169.220.23"
        networks:
            - jm-network

networks:
    jm-network:
        driver: bridge
